<!DOCTYPE html>
<html>
<head>
  <title>Hummble VS</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; display: flex; flex-direction: column; align-items: center; }
  #outputContainer { display: flex; align-items: flex-start; width: 100%; justify-content: center; }
  #output { border: 1px solid #ccc; padding: 10px; margin-top: 10px; width: 50%; height: 70vh; overflow-y: scroll; }
  #setup { 
    position: absolute; 
    right: 40px; /* Adjust this value to set how far from the right edge */
    top: 160px;  /* Adjust this value to align with the top of the output window */
  }
  
  #continue { 
    position: absolute; 
    right: 40px; /* Adjust this value to set how far from the right edge */
    top: 190px;  /* Adjust this value to align with the top of the output window */
  }
  
  #save { 
    position: absolute; 
    right: 40px; /* Adjust this value to set how far from the right edge */
    top: 220px;  /* Adjust this value to align with the top of the output window */
  }
  
  #reset { 
    position: absolute; 
    right: 40px; /* Adjust this value to set how far from the right edge */
    top: 250px;  /* Adjust this value to align with the top of the output window */
  }
  
   #monitor { 
    position: absolute; 
    right: 40px; /* Adjust this value to set how far from the right edge */
    top: 280px;  /* Adjust this value to align with the top of the output window */
  }
  
     #toggle { 
    position: absolute; 
    right: 40px; /* Adjust this value to set how far from the right edge */
    top: 310px;  /* Adjust this value to align with the top of the output window */
  }
  
  .controls { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; align-items: center; }
  .controls div { display: flex; gap: 10px; }
  #inputSection { display: flex; gap: 10px; width: 50%; }
  #input { flex-grow: 1; }
</style>
</head>
<body>
  <h1>Hummble Control Interface</h1>
  <div class="controls">
    <div>
      <button id="connect">Connect to Hummble</button>
      <button id="clearOutput">Clear Output</button>
    </div>
    <div id="inputSection">
      <input type="text" id="input" placeholder="Type a message">
      <button id="send">Send</button>
    </div>
  </div>
  <div id="outputContainer">
    <div id="output"></div>
  </div>
  <button id="setup">Setup</button>
  <button id="continue">Continue</button>
  <button id="save">Save</button>
  <button id="reset">Reset</button>
  <button id="monitor">Monitor</button>
  <button id="toggle">Toggle ANC</button>



  <script>
    let port;
    let reader;
    let outputStream;
    let messageBuffer = '';
	let monitoring = true;
    const connectButton = document.getElementById('connect');
    const sendButton = document.getElementById('send');
    const setupButton = document.getElementById('setup');
	const continueButton = document.getElementById('continue');
	const saveButton = document.getElementById('save');
	const resetButton = document.getElementById('reset');
	const monitorButton = document.getElementById('monitor');
	const toggleButton = document.getElementById('toggle');
    const clearOutputButton = document.getElementById('clearOutput');
    const outputDiv = document.getElementById('output');
    const inputField = document.getElementById('input');

    connectButton.addEventListener('click', async () => {
      if (!("serial" in navigator)) {
        outputDiv.innerHTML += 'WebSerial is not supported in this browser.<br>';
        return;
      }

      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        outputDiv.innerHTML += 'Connected to Hummble<br>';

        outputStream = port.writable.getWriter();

        reader = port.readable.getReader();
        readLoop();
      } catch (error) {
        outputDiv.innerHTML += 'Error: ' + error + '<br>';
        console.error('Connect Error:', error);
      }
    });

    sendButton.addEventListener('click', async () => {
      sendMessage(inputField.value + '\n');
    });

    inputField.addEventListener('keypress', async (event) => {
      if (event.key === 'Enter') {
        sendMessage(inputField.value + '\n');
      }
    });

    setupButton.addEventListener('click', async () => {
      sendMessage('<setup>\n');
    });
	
	continueButton.addEventListener('click', async () => {
      sendMessage('<continue>\n');
    });
    saveButton.addEventListener('click', async () => {
      sendMessage('<save:1>\n');
    });
	
	saveButton.addEventListener('click', async () => {
      sendMessage('<save:1>\n');
    });
	
	resetButton.addEventListener('click', async () => {
      sendMessage('<save:0>\n');
    });
	
    monitorButton.addEventListener('click', async () => {
      if (monitoring) {
		monitoring = false;
        sendMessage('<mt:0>\n');
      } 
	  else {
        monitoring = true;
        sendMessage('<mt:3>\n');
      }
    });
	
	toggleButton.addEventListener('click', async () => {
      sendMessage('<toggle>\n');
    });
	


    clearOutputButton.addEventListener('click', () => {
      outputDiv.innerHTML = '';
    });

    async function sendMessage(message) {
      if (!port) {
        outputDiv.innerHTML += 'Error: No device connected<br>';
        return;
      }
      const encoder = new TextEncoder();
      const data = encoder.encode(message);
      await outputStream.write(data);
      inputField.value = '';
    }
	
	// Function to escape HTML characters
	function escapeHtml(unsafe) {
	return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
	}

    async function readLoop() {
      const decoder = new TextDecoder();
      while (true) {
        try {
          const { value, done } = await reader.read();
          if (done) {
            reader.releaseLock();
            break;
          }
          const chunk = decoder.decode(value);
          messageBuffer += chunk;

          let endOfMessageIndex;
        while ((endOfMessageIndex = messageBuffer.indexOf('\n')) !== -1) {
			const message = messageBuffer.slice(0, endOfMessageIndex + 1);
			messageBuffer = messageBuffer.slice(endOfMessageIndex + 1);
			const escapedMessage = escapeHtml(message); // Escape HTML characters
			outputDiv.innerHTML += escapedMessage + '<br>';
			outputDiv.scrollTop = outputDiv.scrollHeight;
		}
        } catch (error) {
          console.error('Read Error:', error);
          break;
        }
      }
    }
  </script>
</body>
</html>
